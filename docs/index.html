<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindBody Coach | å¿ƒæ™ºé«”çµ„æˆç›£æ¸¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .inbody-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155; }
        .accent-bar { transition: width 1s ease-in-out; }
        .report-md { font-size: 1rem; line-height: 1.85; }
        .report-md p { margin: 0.75rem 0; }
        .report-md h1, .report-md h2 { margin: 1.25rem 0 0.75rem; font-weight: 600; }
        .report-md h3 { margin: 1rem 0 0.5rem; font-weight: 600; }
        .report-md ul, .report-md ol { margin: 0.75rem 0 0.75rem 1.25rem; }
        .report-md li { margin: 0.25rem 0; }
        .report-md hr { border: 0; border-top: 1px solid #334155; margin: 1rem 0; }
        .report-md code { background: rgba(15, 23, 42, 0.5); padding: 0.1rem 0.35rem; border-radius: 0.35rem; }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ (é‡å°é ç±¤) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold tracking-tight text-blue-400">MindBody Coach</h1>
            <p class="text-slate-400 mt-2">å¿ƒæ™ºé«”çµ„æˆæ—¥èªŒ</p>
        </header>

        <!-- API Key Input (åƒ…ç¬¬ä¸€æ¬¡éœ€è¦) -->
        <div id="setup-view" class="inbody-card p-6 rounded-2xl mb-6">
            <h2 class="text-lg font-semibold mb-4">âš™ï¸ åˆå§‹åŒ–ç³»çµ±</h2>
            <input type="password" id="api-key" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg mb-4 text-white">
            <button onclick="saveApiKey()" class="w-full bg-blue-600 hover:bg-blue-500 p-3 rounded-lg font-bold transition">å•Ÿå‹•å¿ƒæ™ºå¼•æ“</button>
        </div>

        <!-- Question Section -->
        <div id="question-view" class="hidden space-y-6">
            <div id="questions-container" class="space-y-4">
                <!-- AI é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
            <button onclick="generateReport()" class="w-full bg-emerald-600 hover:bg-emerald-500 p-4 rounded-xl font-bold shadow-lg transition">ç”Ÿæˆå¿ƒæ™º InBody å ±å‘Š</button>
        </div>

        <!-- Result Section (InBody Style) -->
        <div id="result-view" class="hidden inbody-card p-4 md:p-8 rounded-2xl md:rounded-3xl shadow-2xl">
            <div id="report-content" class="prose prose-invert mb-8">
                <!-- AI åˆ†æå ±å‘Š -->
            </div>
            <div class="space-y-3">
                <button onclick="resetApp()" class="w-full bg-slate-700 hover:bg-slate-600 p-3 rounded-lg transition">å†æ¸¬è©¦ä¸€æ¬¡</button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="downloadHistoryCSV()" class="bg-emerald-700 hover:bg-emerald-600 p-3 rounded-lg transition">ğŸ“Š ä¸‹è¼‰ç´¯ç©çµ±è¨ˆ</button>
                    <button onclick="downloadSessionCSV()" class="bg-blue-700 hover:bg-blue-600 p-3 rounded-lg transition">ğŸ“„ ä¸‹è¼‰æœ¬æ¬¡ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
		let apiKey = localStorage.getItem('GEMINI_API_KEY') || "";
        // æ ¹æ“šæ‚¨çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼Œæ›´æ–°ç‚º gemini-2.5-flash-preview-09-2025
        let MODEL = "gemini-3-flash-preview"; 
        let currentQuestions = []; // å„²å­˜ç•¶å‰é¡Œç›®ä»¥ä¾› CSV è¼¸å‡ºä½¿ç”¨

        function saveApiKey() {
            const key = document.getElementById('api-key').value;
            if (key) {
                localStorage.setItem('GEMINI_API_KEY', key);
                apiKey = key;
                initApp();
            }
        }

        async function initApp() {
            if (!apiKey) {
                document.getElementById('setup-view').classList.remove('hidden');
                document.getElementById('question-view').classList.add('hidden');
                return;
            }
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('question-view').classList.remove('hidden');
            await fetchQuestions();
        }

async function fetchQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = "<p class='text-center animate-pulse'>å°‘å¹´ Ti æ­£åœ¨æ§‹æ€é¡Œç›®...</p>";

    // éš¨æ©Ÿæƒ…å¢ƒç”Ÿæˆ
    const scenarioTypes = [
"[çªç™¼] é¢å°æ¯«ç„¡é è­¦çš„è¨­å‚™æ•…éšœ", 
"[ç¤¾äº¤] å¦‚ä½•å„ªé›…åœ°æ‹’çµ•ä¸€å€‹ä¸åˆç†çš„è«‹æ±‚", 
"[ç´°ç¯€] è™•ç†å¤§é‡ç¹ç‘£ä¸”é‡è¤‡çš„æ•¸æ“š", 
"[é æ™¯] æ§‹æ€ä¸‰å¹´å¾Œçš„é•·é ç”Ÿæ´»è—åœ–", 
"[çŸ›ç›¾] é‚è¼¯æ­£ç¢ºä½†å‚·å®³æ„Ÿæƒ…çš„å…©é›£", 
"[å­¸ç¿’] æ¥è§¸ä¸€å€‹å®Œå…¨é™Œç”Ÿçš„æ–°é ˜åŸŸçŸ¥è­˜", 
"[å¯©ç¾] æ±ºå®šä¸€ä»¶ç‰©å“çš„æ“ºæ”¾ä½ç½®èˆ‡é…è‰²", 
"[è§€å¯Ÿ] åœ¨äººç¾¤ä¸­å¯Ÿè¦ºåˆ°ä¸€å€‹å¾®å°çš„ç•°æ¨£", 
"[æ¬ŠåŠ›] å¿…é ˆä¸‹é”ä¸€å€‹æœƒè®“éƒ¨åˆ†äººä¸å¿«çš„æ±ºå®š", 
"[åæ€] é¢å°ä¸€å€‹éå»ç„¡æ³•æŒ½å›çš„éºæ†¾", 
"[å‰µé€ ] å˜—è©¦ç”¨ä¸€ç¨®å…¨æ–°çš„æ–¹æ³•åšåŒæ¨£çš„äº‹", 
"[ç©©å®š] ç‚ºäº†ç¾¤é«”å’Œè«§è€ŒçŠ§ç‰²å€‹äººçš„è¨ˆç•«", 
"[æ•ˆç‡] åœ¨è³‡æºæ¥µåº¦æœ‰é™çš„æƒ…æ³ä¸‹è¿½æ±‚çµæœ", 
"[æ„Ÿå®˜] é¢å°å¼·çƒˆæ°£å‘³ã€å™ªéŸ³æˆ–èº«é«”ä¸é©", 
"[éš±å–»] è§£è®€ä¸€æ®µå«ç³Šä¸æ¸…ã€å……æ»¿æš—ç¤ºçš„è©±", 
"[å†’éšª] æ±ºå®šæ˜¯å¦è¦è¸ä¸Šä¸€æ¢æœªçŸ¥çš„æ·å¾‘"];
    const randomScenario = scenarioTypes[Math.floor(Math.random() * scenarioTypes.length)];
    const themes = ["[æ—¥å¸¸] æ·±å¤œé£Ÿå ‚çš„æ«ƒæª¯",
"[æ—¥å¸¸] é€±æœ«æ—©æ™¨çš„å‚³çµ±å¸‚å ´",
"[æ—¥å¸¸] è¶…å¸‚æ”¶éŠ€å°å‰çš„æ’éšŠ",
"[æ—¥å¸¸] ç¨è‡ªä¸€äººçš„å±…å®¶è£ä¿®",
"[æ—¥å¸¸] é›œäº‚çš„æ›¸æ¡Œæ•´ç†è¨ˆç•«",
"[æ—¥å¸¸] å’–å•¡å»³è§’è½çš„è§€å¯Ÿ",
"[æ—¥å¸¸] æ¼«é•·çš„æ·±å¤œé•·é€”é€šå‹¤",
"[è·å ´] å……æ»¿ç«è—¥å‘³çš„éƒ¨é–€æœƒè­°",
"[è·å ´] åªæœ‰å…©äººçš„é›»æ¢¯ç¤¾äº¤",
"[è·å ´] å°ˆæ¡ˆæ­»ç·šå‰çš„æœ€å¾Œä¸€å°æ™‚",
"[è·å ´] å‰›å…¥è·ç¬¬ä¸€å¤©çš„åˆé¤æ™‚é–“",
"[è·å ´] è™•ç†ä¸€ä»¶æ£˜æ‰‹çš„å®¢æˆ¶æŠ•è¨´",
"[ç§‘å¹»] è³½åšé¾å…‹åŸå¸‚çš„éœ“è™¹é›¨ä¸­",
"[ç§‘å¹»] æ˜Ÿéš›é£›èˆ¹çš„ç¶­è­·è‰™æˆ¿",
"[ç§‘å¹»] æ•¸ä½è™›æ“¬ç©ºé–“çš„æ„è­˜ä¸Šå‚³",
"[ç§‘å¹»] å»¢æ£„å·²ä¹…çš„å¤ªç©ºå¯¦é©—å®¤",
"[å¥‡å¹»] é­”æ³•å­¸é™¢çš„æœŸæœ«è—¥åŠ‘è€ƒè©¦",
"[å¥‡å¹»] ä¸­ä¸–ç´€åŸå ¡çš„åœ°ä¸‹åœ–æ›¸é¤¨",
"[å¥‡å¹»] æ£®æ—æ·±è™•çš„ç²¾éˆéƒ¨è½",
"[å†’éšª] è’å³¶æ±‚ç”Ÿçš„ç¬¬ä¸€æ™š",
"[å†’éšª] å–œé¦¬æ‹‰é›…å±±çš„æš´é¢¨é›ªç´®ç‡Ÿ",
"[å†’éšª] äºç‰¹è˜­ææ–¯çš„æ·±æµ·æ½›æ°´",
"[æƒ…æ„Ÿ] è€åŒå­¸èšæœƒçš„å¯’æš„æ™‚åˆ»",
"[æƒ…æ„Ÿ] å®¶æ—éºç”¢çš„åˆ†é…æœƒè­°",
"[æƒ…æ„Ÿ] é¢å°é™Œç”Ÿäººçš„çªç™¼æ±‚åŠ©",
"[å›æ†¶] ç«¥å¹´æ™‚ä»£çš„ç§˜å¯†åŸºåœ°",
"[å›æ†¶] æ¶ˆå¤±å·²ä¹…çš„è€å®¶å··å¼„",
"[è—è¡“] ç•¶ä»£è—è¡“ç•«å»Šçš„ç„¡è²åƒè§€",
"[è—è¡“] éœ²å¤©éŸ³æ¨‚ç¯€çš„ç‹‚æ­¡é‚Šç·£",
"[æœ«æ—¥] å–ªå±çˆ†ç™¼å¾Œçš„è³‡æºåˆ†é…",
"[æœ«æ—¥] æ ¸å¾Œå†¬å¤©çš„åœ°ä¸‹é¿é›£æ‰€",
"[æŠ½è±¡] ä¸€å€‹åªæœ‰å…‰å½±èˆ‡è²éŸ³çš„å¤¢å¢ƒ"];
    const randomTheme = themes[Math.floor(Math.random() * themes.length)];

    const prompt = `ä½ æ˜¯ä¸€ä½ä¸–ç•Œç´šçš„å¿ƒç†å­¸å®¶èˆ‡å‰µæ„ä½œå®¶ã€‚
è«‹æ ¹æ“šä¸»é¡Œã€${randomTheme}ã€‘ä»¥åŠæƒ…å¢ƒé¡å‹ã€${randomScenario}ã€‘ç”Ÿæˆ 4 é¡Œ MBTI æ¸¬é©—é¡Œ(ä¾‹å¦‚ 'Si-Ne', 'Ti-Fe', 'Se-Ni', 'Te-Fi'ï¼Œä½†è«‹éˆæ´»åˆ†é…ç¶­åº¦ï¼‰ã€‚

è¦æ±‚ï¼š
1. **å»æ¨™ç±¤åŒ–**ï¼šä¸è¦å•ã€Œä½ æ˜¯å¦å–œæ­¡é‚è¼¯ã€ï¼Œè¦å•å…·é«”çš„è¡Œç‚ºï¼Œä¾‹å¦‚ã€Œä½ æœƒæª¢æŸ¥é›»è·¯åœ–çš„æ¨™è¨˜ã€æˆ–ã€Œä½ æ†‘æ„Ÿè¦ºé€£æ¥é›»ç·šã€ã€‚
2. **å ´æ™¯åŒ–**ï¼šå°‡é¡Œç›®èå…¥ã€${randomTheme}ã€‘çš„å…·é«”æƒ…ç¯€ä¸­ã€‚
3. **å ´æ™¯åŒ–**ï¼šå°‡é¡Œç›®é«”ç¾ã€${randomScenario}ã€‘çš„æ±ºç­–å¼µåŠ›ã€‚
4. **éš±è”½æ€§**ï¼šè®“é¸é … A èˆ‡ B çœ‹èµ·ä¾†éƒ½å¾ˆæœ‰é“ç†ï¼Œä¸è¦ä¸€çœ¼å°±èƒ½çœ‹å‡ºåœ¨æ¸¬ä»€éº¼ã€‚
5. **æ ¼å¼è¦æ±‚**ï¼šåªå›å‚³ç´” JSON é™£åˆ—ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜ã€‚

JSON çµæ§‹ï¼š
- 'q': å…·é«”çš„æƒ…å¢ƒæè¿°
- 'a': é¸é … A çš„åæ‡‰
- 'b': é¸é … B çš„åæ‡‰
- 'dim': æ¸¬é‡çš„è»¸ç·š (å¦‚ 'Si-Ne', 'Ti-Fe')
- 'a_val': é¸é … A ä»£è¡¨çš„åŠŸèƒ½
- 'b_val': é¸é … B ä»£è¡¨çš„åŠŸèƒ½

ç¯„ä¾‹ï¼š[{'q':'åœ¨å¤ªç©ºç«™åœé›»æ™‚...','a':'æ‹¿å‡ºç¶­è­·æ‰‹å†Šå°ç…§æ‰‹é›»ç­’æŒ‡ç¤º','b':'æ†‘ç›´è¦ºæ„Ÿè¦ºé›»åŠ›æµå‘ä¸¦å˜—è©¦é‡å•Ÿ','dim':'Si-Ne','a_val':'Si', 'b_val':'Ne'}]`;
        
            try {
                const response = await callGemini(prompt);
                
                // æ›´ç©©å¥çš„ JSON è§£æé‚è¼¯
                let cleanResponse = response.replace(/```json/g, '').replace(/```/g, '').trim();
                const startIndex = cleanResponse.indexOf('[');
                const endIndex = cleanResponse.lastIndexOf(']') + 1;
                
                if (startIndex === -1 || endIndex === 0) {
                    throw new Error("æ¨¡å‹å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æç‚º JSON");
                }
                
                const jsonStr = cleanResponse.substring(startIndex, endIndex);
                currentQuestions = JSON.parse(jsonStr); // å­˜å…¥å…¨åŸŸè®Šæ•¸
                
                container.innerHTML = currentQuestions.map((q, i) => `
                    <div class="inbody-card p-5 rounded-xl border-l-4 border-blue-500">
                        <p class="font-medium mb-3">${i+1}. ${q.q}</p>
                        <div class="space-y-2">
                            <label class="block p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700">
                                <input type="radio" name="q${i}" value="${q.a}" class="mr-2"> ${q.a}
                            </label>
                            <label class="block p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700">
                                <input type="radio" name="q${i}" value="${q.b}" class="mr-2"> ${q.b}
                            </label>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error(error);
                
                let errorMsg = `é¡Œç›®ç”Ÿæˆå¤±æ•—ï¼š${error.message}`;
                
                // å¦‚æœæ˜¯ 404 éŒ¯èª¤ï¼Œå˜—è©¦åˆ—å‡ºå¯ç”¨æ¨¡å‹
                if (error.message.includes('404') || error.message.includes('not found')) {
                    errorMsg += "<br><br>æ­£åœ¨å˜—è©¦å–å¾—å¯ç”¨æ¨¡å‹åˆ—è¡¨...";
                    container.innerHTML = `<p class='text-red-400 text-center'>${errorMsg}</p>`;
                    
                    try {
                        const models = await listAvailableModels();
                        const modelNames = models.map(m => m.name.replace('models/', '')).join(', ');
                        container.innerHTML = `
                            <div class='text-red-400 text-center'>
                                <p class="font-bold mb-2">æ¨¡å‹é…ç½®éŒ¯èª¤ (404)</p>
                                <p class="mb-4">æ‚¨çš„ API Key ç„¡æ³•å­˜å–ç•¶å‰æ¨¡å‹ (${MODEL})ã€‚</p>
                                <div class="bg-slate-800 p-4 rounded text-left text-sm font-mono overflow-auto max-h-40">
                                    <p class="text-green-400 mb-2">æ‚¨çš„å¯ç”¨æ¨¡å‹ï¼š</p>
                                    ${models.map(m => `<div>${m.name}</div>`).join('')}
                                </div>
                                <p class="mt-4 text-sm text-slate-400">è«‹å˜—è©¦æ›´æ›ç¨‹å¼ç¢¼ä¸­çš„ MODEL è®Šæ•¸ç‚ºä¸Šè¿°å…¶ä¸­ä¹‹ä¸€ã€‚</p>
                                <button onclick="location.reload()" class="mt-4 bg-slate-700 px-4 py-2 rounded hover:bg-slate-600">é‡è©¦</button>
                            </div>
                        `;
                    } catch (listError) {
                        container.innerHTML = `
                            <p class='text-red-400 text-center'>
                                ç”Ÿæˆå¤±æ•—: ${error.message}<br>
                                ä¸”ç„¡æ³•å–å¾—æ¨¡å‹åˆ—è¡¨: ${listError.message}<br>
                                è«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºã€‚
                                <br>
                                <button onclick="localStorage.removeItem('GEMINI_API_KEY'); location.reload();" class="mt-4 bg-red-700 px-4 py-2 rounded hover:bg-red-600">æ¸…é™¤ Key ä¸¦é‡è©¦</button>
                            </p>`;
                    }
                } else {
                    container.innerHTML = `<p class='text-red-400 text-center'>ç”Ÿæˆå¤±æ•—: ${error.message} <br> <button onclick="location.reload()" class="mt-4 bg-slate-700 px-4 py-2 rounded">é‡è©¦</button></p>`;
                }
            }
        }

        async function listAvailableModels() {
            const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`List Models Failed: ${response.statusText}`);
            const data = await response.json();
            return data.models || [];
        }

        async function generateReport() {
            const answers = [];
            const sessionData = [];
            const timestamp = new Date().toLocaleString();

            // 1. æ”¶é›†ç­”æ¡ˆ
            for (let i = 0; i < 4; i++) {
                const checked = document.querySelector(`input[name="q${i}"]:checked`);
                if (!checked) return alert("è«‹å®Œæˆæ‰€æœ‰å¿ƒæ™ºæ¸¬é‡");
                
                const answerText = checked.value;
                answers.push(answerText);
                
                const q = currentQuestions[i];
                const selectedScore = (answerText === q.a) ? q.a_val : q.b_val;
                
                sessionData.push({
                    timestamp: timestamp,
                    dimension: q.dim,
                    question: q.q,
                    option_a: q.a,
                    option_b: q.b,
                    user_answer: answerText,
                    score: selectedScore
                });
            }

            // 2. å„²å­˜æ­·å²ç´€éŒ„
            const history = JSON.parse(localStorage.getItem('MBTI_HISTORY') || '[]');
            history.push(...sessionData);
            localStorage.setItem('MBTI_HISTORY', JSON.stringify(history));
            
            // ä¿å­˜æœ¬æ¬¡è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸ä¾›ä¸‹è¼‰ä½¿ç”¨
            window.currentSessionData = sessionData;

            // 3. åˆ‡æ›ç•«é¢
            document.getElementById('question-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            const reportDiv = document.getElementById('report-content');
            reportDiv.innerHTML = "<p class='animate-pulse text-blue-400 text-center'>æ­£åœ¨åˆ†ææ‚¨çš„å¿ƒæ™ºé«”çµ„æˆ...</p>";

            // 4. è¨­å®š AI æç¤ºè©
            const prompt = `ç”¨æˆ¶å›ç­”äº†ä»¥ä¸‹å•é¡Œï¼š${JSON.stringify(answers)}ã€‚è«‹çµåˆ ISFJ çš„èƒŒæ™¯ï¼Œåˆ†æå…¶ Si, Ti, Fe, Ne æŒ‡æ•¸ã€‚
            è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown çµæ§‹è¼¸å‡ºï¼ˆå‹™å¿…ä¿ç•™ ## 1. / ## 2. / ## 3. æ¨™é¡Œï¼‰ï¼š

            ## 1. æŒ‡æ•¸ç¸½è¦½
            - ä¸€å€‹ Markdown è¡¨æ ¼ï¼ˆæŒ‡æ¨™ | ä»Šæ—¥ç‹€æ…‹(0-100) | è§£è®€ï¼‰
            - 3 é»é‡é»æ‘˜è¦

            ## 2. æ·±åº¦è§£æ
            ### Si
            ### Fe
            ### Ti
            ### Ne
            (æ¯æ®µåŒ…å«ï¼šè¡¨ç¾ã€å¯èƒ½å£“åŠ›é»ã€ä»Šæ—¥ä¸€å€‹å°ç·´ç¿’)

            ## 3. ç¶œåˆå»ºè­°
            - 1 å¥è©±ä»Šæ—¥ç¸½çµ
            - 3 æ¢ç·¨è™Ÿå»ºè­°`;
            
            try {
                // 5. å‘¼å« AI ç”Ÿæˆå ±å‘Š
                const report = await callGemini(prompt);
                
                // 6. è§£æ Markdown å€å¡Šä¸¦æº–å‚™é ç±¤
                const section1Match = report.match(/## 1\. (.*?)\n([\s\S]*?)(?=## 2\.|$)/);
                const section2Match = report.match(/## 2\. (.*?)\n([\s\S]*?)(?=## 3\.|$)/);
                const section3Match = report.match(/## 3\. (.*?)\n([\s\S]*?)$/);

                if (section1Match && section2Match && section3Match) {
                    const tabs = [
                        { title: "ğŸ“Š æŒ‡æ•¸ç¸½è¦½", content: section1Match[2].trim() },
                        { title: "ğŸ§  æ·±åº¦è§£æ", content: section2Match[2].trim() },
                        { title: "ğŸ’¡ ç¶œåˆå»ºè­°", content: section3Match[2].trim() },
                        { title: "ğŸ“ˆ ç´¯ç©è¶¨å‹¢", content: buildTrendTableHTML(history), isHtml: true },
                        { title: "âš–ï¸ å¿ƒæ™ºç‹€æ…‹", content: buildMentalStateTableHTML(history), isHtml: true }, // é€™è£¡æˆåŠŸåŠ å…¥æ–°é ç±¤äº†ï¼
                        { title: "ğŸ§¾ æœ¬æ¬¡ç´€éŒ„", content: buildSessionTableHTML(sessionData), isHtml: true }
                    ];
                    // åŸ·è¡Œé ç±¤æ¸²æŸ“
                    renderTabs(tabs, reportDiv);
                } else {
                    // å¦‚æœ AI æ²’æŒ‰æ ¼å¼å›å‚³ï¼Œç›´æ¥é¡¯ç¤ºæ•´ä»½ Markdown
                    reportDiv.innerHTML = `<div class="report-md">${enhanceReportHTML(marked.parse(report))}</div>`;
                }
            } catch (error) {
                console.error(error);
                reportDiv.innerHTML = `<p class='text-red-400'>å ±å‘Šç”Ÿæˆå¤±æ•—ï¼š${error.message}</p>`;
            }
        }

        function enhanceReportHTML(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Wrap tables for horizontal scroll & add consistent borders
            temp.querySelectorAll('table').forEach((table) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'overflow-x-auto rounded-xl border border-slate-700 my-4';

                table.classList.add('w-full', 'text-sm');
                table.style.borderCollapse = 'collapse';

                const thead = table.querySelector('thead');
                if (thead) {
                    thead.classList.add('bg-slate-800/60');
                }

                table.querySelectorAll('th').forEach((th) => {
                    th.classList.add('px-3', 'py-2', 'text-left');
                    th.style.borderBottom = '1px solid #334155';
                });

                table.querySelectorAll('td').forEach((td) => {
                    td.classList.add('px-3', 'py-2', 'align-top');
                    td.style.borderBottom = '1px solid #334155';
                });

                const parent = table.parentNode;
                parent.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });

            // Add extra spacing between consecutive lists
            temp.querySelectorAll('ul, ol').forEach((list) => {
                list.classList.add('my-3');
            });

            return temp.innerHTML;
        }

        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function buildSessionTableHTML(sessionData) {
            if (!sessionData || sessionData.length === 0) {
                return `<p class="text-slate-300">å°šç„¡æœ¬æ¬¡å›ç­”è¨˜éŒ„ã€‚</p>`;
            }

            const ts = escapeHtml(sessionData[0].timestamp);
            const rows = sessionData.map((r, idx) => {
                return `
                    <tr class="border-b border-slate-700">
                        <td class="px-3 py-2 text-slate-300 align-top">${idx + 1}</td>
                        <td class="px-3 py-2 text-slate-300 align-top whitespace-nowrap">${escapeHtml(r.dimension)}</td>
                        <td class="px-3 py-2 text-slate-200 align-top">${escapeHtml(r.question)}</td>
                        <td class="px-3 py-2 text-slate-200 align-top">${escapeHtml(r.user_answer)}</td>
                        <td class="px-3 py-2 text-blue-300 align-top whitespace-nowrap">${escapeHtml(r.score)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="mb-4">
                    <p class="text-slate-300 text-sm">æœ¬æ¬¡æ™‚é–“ï¼š<span class="text-slate-200">${ts}</span></p>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-700">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800/60">
                            <tr class="text-left">
                                <th class="px-3 py-2 text-slate-300 font-semibold">#</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">ç¶­åº¦</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">é¡Œç›®</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">é¸æ“‡</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">è¨ˆåˆ†</th>
                            </tr>
                        </thead>
                        <tbody class="bg-slate-900/20">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function buildTrendTableHTML(history) {
            if (!history || history.length === 0) {
                return `<p class="text-slate-300">å°šç„¡ç´¯ç©è¨˜éŒ„ã€‚</p>`;
            }

            const counts = {};
            history.forEach(r => {
                if (!r || !r.score) return;
                counts[r.score] = (counts[r.score] || 0) + 1;
            });

            const axes = [
                { axis: 'Si-Ne', left: 'Si', right: 'Ne' },
                { axis: 'Ti-Fe', left: 'Ti', right: 'Fe' },
                { axis: 'Se-Ni', left: 'Se', right: 'Ni' },
                { axis: 'Te-Fi', left: 'Te', right: 'Fi' }
            ];

            const axisRows = axes.map(a => {
                const l = counts[a.left] || 0;
                const r = counts[a.right] || 0;
                const d = l + r;
                const lp = d ? Math.round((l / d) * 100) : 0;
                const rp = d ? Math.round((r / d) * 100) : 0;
                return `
                    <tr class="border-b border-slate-700">
                        <td class="px-3 py-2 text-slate-300 whitespace-nowrap">${a.axis}</td>
                        <td class="px-3 py-2 text-slate-200 whitespace-nowrap">${a.left}: ${l} (${lp}%)</td>
                        <td class="px-3 py-2 text-slate-200 whitespace-nowrap">${a.right}: ${r} (${rp}%)</td>
                        <td class="px-3 py-2 text-slate-300">${d}</td>
                    </tr>
                `;
            }).join('');

            const total = history.length;
            return `
                <div class="mb-4">
                    <p class="text-slate-300 text-sm">ç´¯ç©é¡Œæ•¸ï¼š<span class="text-slate-200">${total}</span></p>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-700">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800/60">
                            <tr class="text-left">
                                <th class="px-3 py-2 text-slate-300 font-semibold">è»¸</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">å·¦å´</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">å³å´</th>
                                <th class="px-3 py-2 text-slate-300 font-semibold">è©²è»¸é¡Œæ•¸</th>
                            </tr>
                        </thead>
                        <tbody class="bg-slate-900/20">
                            ${axisRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTabs(tabs, container) {
            container.innerHTML = '';
            
            // Tab Headers Container
            const header = document.createElement('div');
            header.className = 'flex border-b border-slate-700 mb-6 overflow-x-auto no-scrollbar sticky top-0 bg-slate-900/90 backdrop-blur-md z-10 -mx-4 px-4 md:mx-0 md:px-0';
            
            // Tab Contents Container
            const contentContainer = document.createElement('div');
            
            tabs.forEach((tab, index) => {
                // Create Tab Button
                const btn = document.createElement('button');
                btn.className = `px-3 py-3 font-medium text-sm whitespace-nowrap transition-all duration-200 border-b-2 ${index === 0 ? 'text-blue-400 border-blue-400' : 'text-slate-400 border-transparent hover:text-slate-200 hover:border-slate-600'}`;
                btn.innerText = tab.title;
                
                // Create Content Pane
                const pane = document.createElement('div');
                pane.id = `tab-pane-${index}`;
                pane.className = `max-w-none ${index === 0 ? 'block animate-fade-in' : 'hidden'}`;
                if (tab.isHtml) {
                    pane.innerHTML = tab.content;
                } else {
                    const rawHtml = marked.parse(tab.content);
                    pane.innerHTML = `<div class="report-md">${enhanceReportHTML(rawHtml)}</div>`;
                }
                
                // Click Event
                btn.onclick = () => {
                    // Reset all buttons
                    Array.from(header.children).forEach(b => {
                        b.className = 'px-3 py-3 font-medium text-sm whitespace-nowrap transition-all duration-200 border-b-2 text-slate-400 border-transparent hover:text-slate-200 hover:border-slate-600';
                    });
                    // Activate clicked button
                    btn.className = 'px-3 py-3 font-medium text-sm whitespace-nowrap transition-all duration-200 border-b-2 text-blue-400 border-blue-400';
                    
                    // Hide all panes
                    Array.from(contentContainer.children).forEach(p => p.classList.add('hidden'));
                    // Show target pane
                    pane.classList.remove('hidden');
                    pane.classList.add('animate-fade-in');
                };

                header.appendChild(btn);
                contentContainer.appendChild(pane);
            });

            container.appendChild(header);
            container.appendChild(contentContainer);
        }
        // æ–°å¢ï¼šå¿ƒæ™ºç‹€æ…‹è¨ˆç®—å‡½æ•¸
        function buildMentalStateTableHTML(history) {
            const axes = [
                { id: 'Si-Ne', left: 'Si', right: 'Ne' },
                { id: 'Ti-Fe', left: 'Ti', right: 'Fe' },
                { id: 'Se-Ni', left: 'Se', right: 'Ni' },
                { id: 'Te-Fi', left: 'Te', right: 'Fi' }
            ];

            const rows = axes.map(axis => {
                // ç¯©é¸è©²ç¶­åº¦çš„æ‰€æœ‰æ­·å²è¨˜éŒ„
                // åŸæœ¬ä»¥å®Œå…¨æ¯”å° axis.idï¼Œå¯èƒ½å› ç‚º model å›å‚³çš„ dim æ ¼å¼ï¼ˆç©ºç™½ã€é †åºæˆ–åˆ†éš”ç¬¦ï¼‰ä¸ä¸€è‡´ï¼Œå°è‡´æ¼ç®—ã€‚
                // æ”¹ç‚ºåˆ¤æ–· dimension æ˜¯å¦åŒæ™‚åŒ…å«å·¦å³å…©å€‹åŠŸèƒ½åï¼ˆå¿½ç•¥å¤§å°å¯«èˆ‡ç©ºç™½ï¼‰ï¼Œä»¥æé«˜å®¹éŒ¯æ€§ã€‚
                const axisData = history.filter(h => {
                    if (!h || !h.dimension) return false;
                    const dim = String(h.dimension).toLowerCase();
                    const left = String(axis.left).toLowerCase();
                    const right = String(axis.right).toLowerCase();
                    return dim.includes(left) && dim.includes(right);
                });
                const count = axisData.length;

                if (count < 21) {
                    return `
                        <tr class="border-b border-slate-700">
                            <td class="px-3 py-4 text-slate-300 font-medium">${axis.id}</td>
                            <td colspan="3" class="px-3 py-4 text-slate-500 text-center italic">
                                æ¸¬å®šä¸­ (ç›®å‰ç´¯ç©: ${count} / 21)
                            </td>
                        </tr>
                    `;
                }

                // å–æœ€è¿‘ 21 ç­†
                const last21 = axisData.slice(-21);
                
                // 1. è¨ˆç®— 21 å¤©å¹³å‡å€¼ (å·¦å´åŠŸèƒ½çš„ä½”æ¯”)
                const leftCount = last21.filter(d => d.score === axis.left).length;
                const avg = Math.round((leftCount / 21) * 100);

                // 2. è¨ˆç®—æ³¢å‹• (åˆ©ç”¨ 5 ç­†è³‡æ–™çš„æ»‘å‹•çª—å£ä¾†æ‰¾å‡ºæ¥µç«¯å€¼)
                // é€™èƒ½é¡¯ç¤ºä½ åœ¨é€™ 21 å¤©å…§ï¼Œæœ€æ¥µç«¯åå‘æŸä¸€æ–¹çš„æ™‚åˆ»
                let maxIntensity = 0; // æœ€é«˜å·¦å´ä½”æ¯”
                let minIntensity = 100; // æœ€ä½å·¦å´ä½”æ¯” (å³æœ€é«˜å³å´ä½”æ¯”)
                const windowSize = 5;

                for (let i = 0; i <= last21.length - windowSize; i++) {
                    const window = last21.slice(i, i + windowSize);
                    const windowLeftCount = window.filter(d => d.score === axis.left).length;
                    const intensity = (windowLeftCount / windowSize) * 100;
                    if (intensity > maxIntensity) maxIntensity = intensity;
                    if (intensity < minIntensity) minIntensity = intensity;
                }

                return `
                    <tr class="border-b border-slate-700 hover:bg-slate-800/30 transition">
                        <td class="px-3 py-4 text-slate-200 font-semibold">${axis.id}</td>
                        <td class="px-3 py-4">
                            <div class="text-blue-400 font-bold">${avg}% ${axis.left}</div>
                            <div class="text-xs text-slate-500">21æ—¥åŸºæº–ç·š</div>
                        </td>
                        <td class="px-3 py-4 text-slate-300">
                            <span class="text-emerald-400">${maxIntensity}%</span> / 
                            <span class="text-rose-400">${minIntensity}%</span>
                        </td>
                        <td class="px-3 py-4">
                            <div class="w-full bg-slate-800 rounded-full h-1.5 mt-2 overflow-hidden flex">
                                <div class="bg-blue-500 h-full" style="width: ${avg}%"></div>
                                <div class="bg-slate-600 h-full" style="width: ${100-avg}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-blue-300 mb-2">ğŸ§  å¿ƒç†åŠŸèƒ½ç©©å®šæ€§ç›£æ¸¬ (æœ€è¿‘ 21 æ¬¡ç´€éŒ„)</h3>
                    <p class="text-xs text-slate-400 mb-4">
                        â€» <b>å¹³å‡å€¼</b>ä»£è¡¨æ‚¨çš„æ ¸å¿ƒåå¥½ï¼›<b>æœ€å¤§/æœ€å°å€¼</b>åæ˜ æƒ…ç·’æˆ–å£“åŠ›ä¸‹çš„åŠŸèƒ½æ“ºç›ªï¼ˆä»¥ 5 æ¬¡ç‚ºå–®ä½ä¹‹æ¿ƒåº¦è®ŠåŒ–ï¼‰ã€‚
                    </p>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-700">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800/60">
                            <tr class="text-left">
                                <th class="px-3 py-3 text-slate-300 font-semibold">åŠŸèƒ½è»¸ç·š</th>
                                <th class="px-3 py-3 text-slate-300 font-semibold">21æ—¥å‡å€¼</th>
                                <th class="px-3 py-3 text-slate-300 font-semibold">å³°å€¼æ³¢å‹• (é«˜/ä½)</th>
                                <th class="px-3 py-3 text-slate-300 font-semibold">èƒ½é‡åˆ†ä½ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-blue-900/20 border border-blue-800/50 rounded-lg">
                    <p class="text-xs text-blue-200 leading-relaxed">
                        <b>ISFJ æˆé•·æé†’ï¼š</b> è‹¥ç‰¹å®šè»¸ç·šï¼ˆå¦‚ Ti-Feï¼‰ä¹‹æ³¢å‹•æ¥µå¤§ï¼ˆä¾‹å¦‚ 100% / 0%ï¼‰ï¼Œä»£è¡¨æ‚¨å¯èƒ½æ­£è™•æ–¼ã€ŒåŠŸèƒ½æ‹‰é‹¸ã€ç‹€æ…‹ã€‚ç©©å®šçš„ Si éœ€è¦é©åº¦çš„ Ne æ³¢å‹•ä¾†ä¿æŒæ´»åŠ›ï¼Œä½†éå¤§çš„æ³¢å‹•å¯èƒ½é ç¤ºè‘—å£“åŠ›éè¼‰ã€‚
                    </p>
                </div>
            `;
        }
        
        async function callGemini(prompt, specificModel = null) {
            const currentModel = specificModel || MODEL;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) {
                    // è™•ç† 503 Overloaded éŒ¯èª¤ï¼šè‡ªå‹•åˆ‡æ›è‡³å‚™ç”¨æ¨¡å‹
                    if (response.status === 503) {
                        if (!specificModel) {
                            console.warn(`Model ${currentModel} overloaded. Switching to fallback: gemini-2.0-flash`);
                            // é¡¯ç¤ºä¸€å€‹å°çš„ Toast æˆ– Log è®“ç”¨æˆ¶çŸ¥é“æ­£åœ¨é‡è©¦ (å¯é¸ï¼Œé€™è£¡å…ˆç”¨ console)
                            await new Promise(r => setTimeout(r, 1000)); // ç­‰å¾… 1 ç§’
                            return callGemini(prompt, "gemini-2.0-flash");
                        }
                    }

                    const errData = await response.json().catch(() => ({}));
                    throw new Error(`API Error ${response.status}: ${errData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("No content in response (Safety filter might be triggered)");
                }
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                throw e;
            }
        }

        function resetApp() {
            location.reload();
        }

        function downloadCSV(data, filename) {
            // å°‡ JSON é™£åˆ—è½‰æ›ç‚º CSV
            if (!data || data.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            // åŠ å…¥æ¨™é¡Œåˆ—
            csvRows.push(headers.join(','));
            
            // åŠ å…¥è³‡æ–™åˆ—
            for (const row of data) {
                const values = headers.map(header => {
                    const val = row[header] || '';
                    // è™•ç†åŒ…å«é€—è™Ÿæˆ–æ›è¡Œçš„æ¬„ä½ï¼Œç”¨é›™å¼•è™ŸåŒ…èµ·ä¾†
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }
            
            // å»ºç«‹ä¸‹è¼‰é€£çµï¼ˆç§»é™¤ BOMï¼Œä½¿ç”¨ç´” UTF-8ï¼‰
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadHistoryCSV() {
            const history = JSON.parse(localStorage.getItem('MBTI_HISTORY') || '[]');
            if (history.length === 0) {
                alert('å°šç„¡ç´¯ç©è¨˜éŒ„');
                return;
            }
            const timestamp = new Date().toISOString().slice(0, 10);
            downloadCSV(history, `MBTIç´¯ç©çµ±è¨ˆ_${timestamp}.csv`);
        }

        function downloadSessionCSV() {
            // å¾å…¨åŸŸè®Šæ•¸å–å¾—æœ¬æ¬¡çš„ sessionDataï¼ˆéœ€è¦åœ¨ generateReport ä¸­ä¿å­˜ï¼‰
            const sessionData = window.currentSessionData;
            if (!sessionData || sessionData.length === 0) {
                alert('å°šç„¡æœ¬æ¬¡è¨˜éŒ„');
                return;
            }
            const timestamp = new Date().toISOString().slice(0, 10);
            downloadCSV(sessionData, `MBTIæœ¬æ¬¡ç´€éŒ„_${timestamp}.csv`);
        }

        if (apiKey) initApp();
    </script>
</body>
</html>